<!DOCTYPE html>




 <html class="no-js"> 
<head>

<script type="text/javascript">
theBaseUrl = "http://vamp.io/";
</script>
<base href="http://vamp.io/" />

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
  <title>Workflows - Vamp</title>
  <meta name="generator" content="Hugo 0.16" />

  
  <meta name="description" content="Vamp - Deploy and manage microservices with power and ease.">
  
  <link rel="canonical" href="./documentation/using-vamp/workflows/">
  
  <meta name="author" content="magnetic.io">
  

  <meta property="og:url" content="/documentation/using-vamp/workflows/">
  <meta property="og:title" content="Vamp">
  <meta property="og:image" content="/images/logo.svg">
  <meta name="apple-mobile-web-app-title" content="Vamp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="shortcut icon" type="image/x-icon" href="./images/logo.svg">
  <link rel="icon" type="image/x-icon" href="./images/logo.svg">


  <style>
    @font-face {
      font-family: 'Icon';
      src: url('fonts/icon.eot?52m981');
      src: url('fonts/icon.eot?#iefix52m981')
      format('embedded-opentype'),
      url('fonts/icon.woff?52m981')
      format('woff'),
      url('fonts/icon.ttf?52m981')
      format('truetype'),
      url('fonts/icon.svg?52m981#icon')
      format('svg');
      font-weight: normal;
      font-style: normal;
    }
  </style>

  <link rel="stylesheet" href="css/style.css">

  <script src="js/vendor.js"></script>

  <script src="js/app.js"></script>

  
</head>
<body class="palette-primary-pink palette-accent-pink">


<div class="single-page">
  <nav aria-label="Header" id="header" class="top-menu">
  <div class="left">
    <a href="./">
      <div id="logo" class="logo"></div>
    </a>
  </div>

  <div class="right">
    <div class="top-menu-items" id="top-menu-items">

    </div>

    <div class="download">
      <a href="./documentation/installation/hello-world/" class="button button--red">
        Try Vamp
      </a>
    </div>

    <a href="https://github.com/magneticio/vamp" target="_blank" class="github-logo">
      <i class="fa fa-2x fa-github" aria-hidden="true"></i>
    </a>

    <div class="search-button">
      <i class="fa fa-lg fa-search"></i>
    </div>

  </div>
</nav>

<ul id="mobile-menu" style="display: none">
</ul>

<div id="search">
  <div class="search-bar">
    <div class="search-bar__back">
      <i class="fa fa-lg fa-times"></i>
    </div>
    <input class="search-bar__input" placeholder="Type your search here...">
  </div>
  <div class="search-results">
    <ul></ul>
  </div>
</div>


</div>

<div class="page documentation">
    <div class="menu" id="side-menu">
    </div>
    <div class="content">
      <h1 class="content-header">Workflows </h1>
      <div class="markdowned">
        

<p>A &ldquo;workflow&rdquo; is an automated change of the running system and its deployments and gateways.
Changing the number of running instances based on metrics (e.g. SLA) is an example of a workflow.
A workflow can be seen as a recipe or solution, however it has a more generic meaning not just related to &ldquo;problematic&rdquo; situations.</p>

<p>Another example is a workflow that will decide automatically if a new version, when doing a canary release, should be accepted or not.
For instance, push the route up to 50% of traffic to the new version, compare metrics over some time (e.g. frequency of 5xx errors, response time), change to 100% and remove the old version.
This workflow could define the rate of the transitions (e.g. 5% -&gt; 10% -&gt; 25%, &hellip;) as well.</p>

<h2 id="rationale">Rationale</h2>

<p>Workflows allow closing the feedback loop: deploy, measure, <strong>react</strong>.
Vamp workflows are based on running separate services (breeds) and in its simplest form scripting can be used - e.g. <code>application/javascript</code> breeds.
Scripting allows experimentation with different features and if the feature is common and generic enough, it could be supported later in Vamp DSL.
Since workflows are running breeds in similar way as in deployments (blueprints), all other breed features are supported - ports, environment variables etc.</p>

<h2 id="workflow-api">Workflow API</h2>

<ul>
<li>Each workflow is represented as an artifact and they follow basic CRUD operation patterns as any other artifact:
<code>
/api/v1/workflows
</code></li>
</ul>

<p>Each workflow has to have:</p>

<ul>
<li><code>name</code></li>
<li><code>breed</code> - either reference or inline definition, similar to blueprints</li>
<li><code>schedule</code></li>
<li><code>scale</code> - optional</li>
<li><code>environment_variables</code> (or <code>env</code>)- overrides breed environment variables</li>
<li><code>arguments</code>- Docker arguments, overrides default configuration arguments and breed arguments</li>
</ul>

<p>Example:</p>

<pre><code class="language-yaml">---
name: metrics
breed: metrics   # breed reference, inline definition can be also used
schedule: daemon
scale:           # inline scale, reference definition can be also used, e.g. scale: small
  cpu: 1
  memory: 128MB
  instances: 2
environment_variables:
  interval: 5s
</code></pre>

<h3 id="schedule">Schedule</h3>

<p>Following schedule types are supported:</p>

<ul>
<li><code>daemon</code></li>
<li><code>event</code> with <code>tags</code> (set)</li>
<li><code>time</code> - <code>period</code>, <code>start</code> (optional, by default starts now) and <code>repeat</code> (optional, by default runs forever)</li>
</ul>

<p>Examples:</p>

<pre><code class="language-yaml">---
schedule: daemon
  
# time schedule

schedule:
  time:
    period: P1Y2M3DT4H5M6S
    start: now # or e.g. start: 2016-12-03T08:15:30Z
    repeat: 10

# event schedule

schedule:
  event: # event with following tags will trigger the workflow
  - deployments:sava
  - cluster:runner
  
# or shorten notation in case of single event (still array can be used as above)

schedule:
  event: archive:bluprints

</code></pre>

<p>Time schedule period is in <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO8601</a> repeating interval notation.</p>

<p>Example:</p>

<pre><code class="language-yaml">---
name    : metrics
schedule: daemon
breed   :
  name: metrics
  deployable:
    type: application/javascript
    definition: |
      'use strict';
      
      var _ = require('lodash');
      var vamp = require('vamp-node-client');
      
      var api = new vamp.Api();
      var metrics = new vamp.Metrics(api);
      
      var period = 5;  // seconds
      var window = 30; // seconds
      
      var process = function() {
        api.gateways(function (gateways) {
          _.forEach(gateways, function(gateway) {
            metrics.average({ 
              ft: gateway.lookup_name 
            }, 'Tt', window, function(total, rate, responseTime) {
              api.event(['gateways:' + gateway.name, 'metrics:rate'], rate);
              api.event(['gateways:' + gateway.name, 'metrics:responseTime'], responseTime);
            });
          });
        });ß
      };
      
      setInterval(process, period * 1000);
</code></pre>

<div class="admonition note">
  <p class="admonition-title">Note!</p>
  <p>Probably it would be better to keep breed as a reference and create breed as shown below:</p>
</div>

<pre><code>PUT Content-Type: application/javascript /api/v1/breeds/metrics
</code></pre>

<pre><code class="language-javascript">'use strict';

var _ = require('lodash');
var vamp = require('vamp-node-client');

var api = new vamp.Api();
var metrics = new vamp.Metrics(api);

var period = 5;  // seconds
var window = 30; // seconds

var process = function() {
  api.gateways(function (gateways) {
      _.forEach(gateways, function(gateway) {
          metrics.average({ ft: gateway.lookup_name }, 'Tt', window, function(total, rate, responseTime) {
              api.event(['gateways:' + gateway.name, 'metrics:rate'], rate);
              api.event(['gateways:' + gateway.name, 'metrics:responseTime'], responseTime);
          });
      });
  });
};

setInterval(process, period * 1000);
</code></pre>

<p>JavaScript breeds will be executed by Vamp Workflow Agent (<a href="https://github.com/magneticio/vamp-workflow-agent">github.com/magneticio - Vamp workflow agent</a>).</p>

<p>For additional JavaScript API check out Vamp Node Client (<a href="https://github.com/magneticio/vamp-node-client">github.com/magneticio - Vamp node client</a>) project.</p>

<div class="admonition note">
  <p class="admonition-title">What next?</p>
  <p><ul>
<li>Read about <a href="./documentation/using-vamp/sticky-sessions/">Sticky sessions</a></li>
<li>Check the <a href="./documentation/api/api-reference">API documentation</a></li>
<li><a href="./documentation/installation/hello-world">Try Vamp</a></li>
</ul>
</p>
</div>

      </div>
    </div>
</div>

<div class="lander-row lander-row--blue footer">
  <div class="container">
    <div class="row">
      <div class="col col-3">
        <h2 class="h2">Learn more</h2>
        <a href="./why-use-vamp/">
          <p class="text">Why use Vamp?</p>
        </a>
        <a href="./documentation/how-vamp-works/architecture-and-components">
          <p class="text">Documentation</p>
        </a>
        <a href="./about/">
          <p class="text">About us</p>
        </a>
        <a href="./resources/news/">
          <p class="text">News</p>
        </a>
        <a href="./contact/">
          <p class="text">Contact</p>
        </a>
      </div>
        <div class="col col-6">
        <h2 class="h2">All things code</h2>
          <a href="./support/">
            <p class="text">Support</p>
          </a>
          <a href="./resources/community/">
            <p class="text">Community</p>
          </a>
          <a href="https://github.com/magneticio/vamp" target="_blank">
            <p class="text">GitHub</p>
          </a>
          <a href="https://gitter.im/magneticio/vamp" target="_blank">
            <p class="text">Gitter</p>
          </a>
      </div>
      <div class="col col-6">
        <h2 class="h2">Stay up to date</h2>
        <p class="text">
          Leave your email for the latest news: We won’t spam you and won’t go off topic.
        </p>

        <form action="//magnetic.us9.list-manage.com/subscribe/post?u=c709b3ab8cce9e00d617e01b6&amp;id=c1465e21d0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate form-inline" style="display: inline" target="_blank" novalidate="">
          <div class="input-group">
            <input type="email" name="EMAIL" id="mce-EMAIL" placeholder="Email">
            <a onclick="$(this).closest('form').submit()" class="button button--red not-active">
              <div class="button__icon button__icon--mail">
              </div>
            </a>
          </div>
        </form>

        
          
        


        <div class="social-buttons">
          <p class="text">Follow us on: </p>
          <a href="https://twitter.com/vamp_io" target="_blank">
            <i class="fa fa-2x fa-twitter"></i>
          </a>

          <a href="https://www.linkedin.com/company/magnetic-io" target="_blank">
            <i class="fa fa-2x fa-linkedin"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="footer-bottom lander-row--blue">
  <div class="container">
    <div class="part">
      <a href="./about/"><img class="magnetic-logo" src="./img/005-vamp/Logo/magnetic-logo-footer.svg" alt=""></a>
    </div>
    <div class="part">
      <img class="vamp-bat" src="./img/003-Small-icons/Medium-blue/VAMP-Medium.svg" alt="">
      <p class="text">Code licensed under <a type="application/rss+xml" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2</a> © 2016 <a href="./about/">Magnetic.io</a></p>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59948816-1', 'auto');
  ga('send', 'pageview');

</script>

