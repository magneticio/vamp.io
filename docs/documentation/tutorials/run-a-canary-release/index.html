<!DOCTYPE html>




 <html class="no-js"> 
<head>

<script type="text/javascript">
theBaseUrl = "http://vamp.io/";
</script>
<base href="http://vamp.io/" />

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
  <title>Run a canary release - Vamp</title>
  <meta name="generator" content="Hugo 0.16" />

  
  <meta name="description" content="Vamp - Deploy and manage microservices with power and ease.">
  
  <link rel="canonical" href="./documentation/tutorials/run-a-canary-release/">
  
  <meta name="author" content="magnetic.io">
  

  <meta property="og:url" content="/documentation/tutorials/run-a-canary-release/">
  <meta property="og:title" content="Vamp">
  <meta property="og:image" content="/images/logo.svg">
  <meta name="apple-mobile-web-app-title" content="Vamp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="shortcut icon" type="image/x-icon" href="./images/logo.svg">
  <link rel="icon" type="image/x-icon" href="./images/logo.svg">


  <style>
    @font-face {
      font-family: 'Icon';
      src: url('fonts/icon.eot?52m981');
      src: url('fonts/icon.eot?#iefix52m981')
      format('embedded-opentype'),
      url('fonts/icon.woff?52m981')
      format('woff'),
      url('fonts/icon.ttf?52m981')
      format('truetype'),
      url('fonts/icon.svg?52m981#icon')
      format('svg');
      font-weight: normal;
      font-style: normal;
    }
  </style>

  <link rel="stylesheet" href="css/style.css">

  <script src="js/vendor.js"></script>

  <script src="js/app.js"></script>

  
</head>
<body class="palette-primary-pink palette-accent-pink">


<div class="single-page">
  <nav aria-label="Header" id="header" class="top-menu">
  <div class="left">
    <a href="./">
      <div id="logo" class="logo"></div>
    </a>
  </div>

  <div class="right">
    <div class="top-menu-items" id="top-menu-items">

    </div>

    <div class="download">
      <a href="./documentation/installation/hello-world/" class="button button--red">
        Try Vamp
      </a>
    </div>

    <a href="https://github.com/magneticio/vamp" target="_blank" class="github-logo">
      <i class="fa fa-2x fa-github" aria-hidden="true"></i>
    </a>

    <div class="search-button">
      <i class="fa fa-lg fa-search"></i>
    </div>

  </div>
</nav>

<ul id="mobile-menu" style="display: none">
</ul>

<div id="search">
  <div class="search-bar">
    <div class="search-bar__back">
      <i class="fa fa-lg fa-times"></i>
    </div>
    <input class="search-bar__input" placeholder="Type your search here...">
  </div>
  <div class="search-results">
    <ul></ul>
  </div>
</div>


</div>

<div class="page documentation">
    <div class="menu" id="side-menu">
    </div>
    <div class="content">
      <h1 class="content-header">Run a canary release </h1>
      <div class="markdowned">
        

<h2 id="overview">Overview</h2>

<p>In the <a href="./documentation/tutorials/deploy-your-first-blueprint/">previous tutorial we deployed our app sava 1.0</a>. If you haven&rsquo;t walked through that part already, please do so before continuing.</p>

<p>Now let&rsquo;s say we have a new version of this great application that we want to canary release into production. We have it containerised as <code>magneticio/sava:1.1.0</code> and are ready to go.</p>

<h4 id="in-this-tutorial-we-will">In this tutorial we will:</h4>

<ol>
<li>Prepare our blueprint</li>
<li>Deploy the new version of our application next to the old one</li>
<li>Use conditions to target specific groups</li>
<li>Learn a bit more about conditions</li>
</ol>

<h2 id="in-depth">In depth</h2>

<h3 id="step-1-prepare-our-blueprint">Step 1: Prepare our blueprint</h3>

<p>Vamp allows you to do canary releases using blueprints. Take a look at the YAML example below. It is quite similar to the blueprint we initially used to deploy sava 1.0.0. However, there are two big differences.</p>

<ul>
<li>The <code>services</code> key holds a list of breeds: one for v1.0.0 and one for v1.1.0 of our app. <a href="./documentation/using-vamp/breeds/">Breeds</a> are Vamp&rsquo;s way of describing static artifacts that can be used in blueprints.</li>
<li>We&rsquo;ve added the <code>routing</code> key which holds the weight of each service as a percentage of all requests. Notice we assigned 50% to our current version 1.0.0 and 50% to the new version 1.1.0 We could also start with a 100% to 0% split, a 99% to 1% split or whatever combination you want <em>as long as all percentages add up to 100% in total</em>.</li>
</ul>

<pre><code class="language-yaml">---
name: sava:1.0
gateways:
  9050: sava/webport
clusters:
  sava:
    gateways:
      routes:
        sava:1.0.0:
          weight: 50%  # weight in percentage
        sava:1.1.0:
          weight: 50%
    services: # services is now a list of breeds
      -
        breed:
          name: sava:1.0.0
          deployable: magneticio/sava:1.0.0
          ports:
            webport: 8080/http
        scale:
          cpu: 0.2
          memory: 64MB
          instances: 1
      -
        breed:
          name: sava:1.1.0 # a new version of our service
          deployable: magneticio/sava:1.1.0
          ports:
            webport: 8080/http
        scale:
          cpu: 0.2
          memory: 64MB
          instances: 1
</code></pre>

<p>You could also just leave out the whole <code>routing</code> section and use the UI to change the weights after we&rsquo;ve done the deployment.</p>

<p><img src="./images/screens/tut2_sliders-v090.gif" alt="" /></p>

<div class="admonition tip">
  <p class="admonition-title"></p>
  <p>There is nothing stopping you from deploying three or more versions and distributing the weight
among them. Just make sure that when doing a straight three-way split you give one service 34% as 33%+33%+33%=99%.</p>
</div>

<h3 id="step-2-deploy-the-new-version-of-our-application-next-to-the-old-one">Step 2: Deploy the new version of our application next to the old one</h3>

<p>It is our goal to update the already running deployment with the new blueprint. Vamp will figure out that v1.0.0
is already there and just add v1.1.0 while setting the correct routing between these services.</p>

<div class="admonition tip">
  <p class="admonition-title"></p>
  <p>You could also create a second blueprint with the new service, and merge this new service to the Sava-cluster so it becomes available for routing traffic to it.</p>
</div>

<h4 id="deploy-using-the-ui">Deploy using the UI</h4>

<ol>
<li>Go to the deployment detail screen and press the <strong>Edit</strong> button.</li>
<li>Copy the blueprint above and paste it over the the deployment that is there.</li>
<li>Press <strong>Save</strong></li>
</ol>

<ul>
<li>Vamp will start working out the differences and update the deployment accordingly.</li>
</ul>

<p><img src="./images/screens/tut2_canary-v090.gif" alt="" /></p>

<h4 id="deploy-using-the-api">Deploy using the API</h4>

<ol>
<li>Get the running deployment&rsquo;s name (the UUID) from <code>/api/v1/deployments</code> (or use the explicit name that you used for the deployment).</li>
<li><code>PUT</code> the blueprint to that resource, e.g: <code>/api/v1/deployments/e1c99ca3-dc1f-4577-aa1b-27f37dba0325</code></li>
</ol>

<h4 id="check-the-deployment-and-routing">Check the deployment and routing</h4>

<p>When Vamp has finished deploying, you can start refreshing your browser at the correct endpoint, e.g. <code>http://192.168.99.100:9050/</code>. The application should switch between responding with a 1.0 page and a 1.1 page.</p>

<p><img src="./images/screens/monolith_canary1.png" alt="" /></p>

<div class="admonition note">
  <p class="admonition-title">Note!</p>
  <p>This works best with the &ldquo;Incognito&rdquo; or &ldquo;Anonymous&rdquo; mode of your browser because of the caching of static assets.</p>
</div>

<h3 id="step-3-use-conditions-to-target-specific-groups">Step 3: Use conditions to target specific groups</h3>

<p>Using percentages to divide traffic between versions is already quite powerful, but also very simplistic.
What if, for instance, you want to specifically target a group of users? Or a specific channel of requests
from an internal service? Vamp allows you to do this right from the blueprint DSL.</p>

<p>Let&rsquo;s start simple: We will allow only Chrome users to access v1.1.0 of our application by inserting this routing scheme:</p>

<pre><code class="language-yaml">---
routes:
  sava:1.1.0:
    weight: 0%
    filter_strength: 100%
    filters:
    - condition: User-Agent = Chrome
</code></pre>

<p>Notice three things:</p>

<ul>
<li>We inserted a list of conditions (with only one condition for now).</li>
<li>We set the filter strength to 100% (it would be also by default set to 100%). This is important because we want all Chrome users to access the new service - we could also say <code>filter_strength: 50%</code> to give access just to half of them (the other 50% would be redirected to weight rules and routed accordingly).</li>
<li>We set the weight to 0% because we don&rsquo;t want any other users to access <code>sava:1.1.0</code></li>
</ul>

<p>The first service where the filter matches the request will be used to handle the request.
<a href="./documentation/using-vamp/gateways/">More information about using filters, weights, sticky sessions etc.</a>.</p>

<p>Our full blueprint now looks as follows:</p>

<pre><code class="language-yaml">---
name: sava:1.0
gateways:
  9050: sava/webport
clusters:
  sava:
    gateways:
      routes:
        sava:1.0.0:
          weight: 100%
        sava:1.1.0:
          weight: 0%
          condition_strength: 100%
          condition: User-Agent = Chrome
    services: # services is now a list of breeds
      -
        breed:
          name: sava:1.0.0
          deployable: magneticio/sava:1.0.0
          ports:
            webport: 8080/http
        scale:
          cpu: 0.2
          memory: 64MB
          instances: 1
      -
        breed:
          name: sava:1.1.0 # a new version of our service
          deployable: magneticio/sava:1.1.0
          ports:
            webport: 8080/http
        scale:
          cpu: 0.2
          memory: 64MB
          instances: 1
</code></pre>

<p>Using the UI, you can either use the <strong>Edit deployment</strong> button again and completely paste in this blueprint or just
find the right place in the blueprint and edit it by hand. The result should be the same as using our UI to insert a filter condition:</p>

<p><img src="./images/screens/tut2_canary-condition-v090.gif" alt="" /></p>

<p>As we are not actually deploying anything but just reconfiguring routes, the update should be almost instantaneous. You can fire up a Chrome browser and a Safari browser and check the results. A hard refresh might be necessary because of your browser&rsquo;s caching routine.</p>

<p><img src="./images/screens/screencap_canary1.gif" alt="" /></p>

<h3 id="step-4-learn-a-bit-more-about-conditions">Step 4: Learn a bit more about conditions</h3>

<p>Our browser example is easily testable on a laptop, but of course a bit contrived. Luckily you can
create much more powerful filters quite easily. Checking Headers, Cookies, Hosts etc. is all possible.
Under the hood, Vamp uses Haproxy&rsquo;s ACL&rsquo;s (<a href="http://cbonte.github.io/haproxy-dconv/configuration-1.5.html#7.1">cbonte.github.io/haproxy-dconv/configuration-1.5 - ACL basics</a>) and you can use the exact ACL definition right in the blueprint in the <code>condition</code> field of a filter.</p>

<h4 id="vamp-short-codes">Vamp short codes</h4>

<p>ACLs can be somewhat opaque and cryptic. That&rsquo;s why Vamp has a set of convenient &ldquo;short codes&rdquo;
to address common use cases. Currently, we support the following, but we will be expanding on this in the future:</p>

<pre><code>User-Agent = *string*
Host = *string*
Cookie *cookie name* Contains *string*
Has Cookie *cookie name*
Misses Cookie *cookie name*
Header *header name* Contains *string*
Has Header *header name*
Misses Header *header name*
</code></pre>

<p>Vamp is also quite flexible when it comes to the exact syntax. This means the following are all equivalent:</p>

<pre><code>hdr_sub(user-agent) Android   # straight ACL
user-agent=Android            # lower case, no white space
User-Agent=Android            # upper case, no white space
user-agent = Android          # lower case, white space
</code></pre>

<h4 id="multiple-conditions-in-a-filter">Multiple conditions in a filter</h4>

<p>Having multiple conditions in a filter is perfectly possible, all filters will be implicitly
&ldquo;OR&rdquo;-ed together, as in <em>&ldquo;if the first filter doesn&rsquo;t match, proceed to the next&rdquo;</em>.</p>

<p>In the example below, the filter would first check whether the string &ldquo;Chrome&rdquo; exists in the User-Agent header of a
request. If that doesn&rsquo;t result in a match, it would check whether the request has the header
&ldquo;X-VAMP-TUTORIAL&rdquo;. So any request matching either condition would go to this service.</p>

<pre><code class="language-yaml">---
routes:
  sava:1.1.0:
    filter_strength: 100%
    filters:
    - condition: User-Agent = Chrome
    - condition: Has Header X-VAMP-TUTORIAL
</code></pre>

<p>Using a tool like httpie (<a href="https://github.com/jakubroztocil/httpie">github.com/jakubroztocil - httpie</a>) makes testing this a breeze.</p>

<pre><code>http GET http://10.26.184.254:9050/ X-VAMP-TUTORIAL:stuff
</code></pre>

<p><img src="./images/screens/screencap_canary2.gif" alt="" /></p>

<div class="admonition note">
  <p class="admonition-title">What next?</p>
  <p><ul>
<li>Cool stuff. But we are dealing here with single, monolithic applications. Where are the microservices?  We will <a href="./documentation/tutorials/split-a-monolith/">chop up this monolith into services and deploy them with Vamp</a> in the third part of our tutorial →</li>
</ul>
</p>
</div>

      </div>
    </div>
</div>

<div class="lander-row lander-row--blue footer">
  <div class="container">
    <div class="row">
      <div class="col col-3">
        <h2 class="h2">Learn more</h2>
        <a href="./why-use-vamp/">
          <p class="text">Why use Vamp?</p>
        </a>
        <a href="./documentation/how-vamp-works/architecture-and-components">
          <p class="text">Documentation</p>
        </a>
        <a href="./about/">
          <p class="text">About us</p>
        </a>
        <a href="./resources/news/">
          <p class="text">News</p>
        </a>
        <a href="./contact/">
          <p class="text">Contact</p>
        </a>
      </div>
        <div class="col col-6">
        <h2 class="h2">All things code</h2>
          <a href="./support/">
            <p class="text">Support</p>
          </a>
          <a href="./resources/community/">
            <p class="text">Community</p>
          </a>
          <a href="https://github.com/magneticio/vamp" target="_blank">
            <p class="text">GitHub</p>
          </a>
          <a href="https://gitter.im/magneticio/vamp" target="_blank">
            <p class="text">Gitter</p>
          </a>
      </div>
      <div class="col col-6">
        <h2 class="h2">Stay up to date</h2>
        <p class="text">
          Leave your email for the latest news: We won’t spam you and won’t go off topic.
        </p>

        <form action="//magnetic.us9.list-manage.com/subscribe/post?u=c709b3ab8cce9e00d617e01b6&amp;id=c1465e21d0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate form-inline" style="display: inline" target="_blank" novalidate="">
          <div class="input-group">
            <input type="email" name="EMAIL" id="mce-EMAIL" placeholder="Email">
            <a onclick="$(this).closest('form').submit()" class="button button--red not-active">
              <div class="button__icon button__icon--mail">
              </div>
            </a>
          </div>
        </form>

        
          
        


        <div class="social-buttons">
          <p class="text">Follow us on: </p>
          <a href="https://twitter.com/vamp_io" target="_blank">
            <i class="fa fa-2x fa-twitter"></i>
          </a>

          <a href="https://www.linkedin.com/company/magnetic-io" target="_blank">
            <i class="fa fa-2x fa-linkedin"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="footer-bottom lander-row--blue">
  <div class="container">
    <div class="part">
      <a href="./about/"><img class="magnetic-logo" src="./img/005-vamp/Logo/magnetic-logo-footer.svg" alt=""></a>
    </div>
    <div class="part">
      <img class="vamp-bat" src="./img/003-Small-icons/Medium-blue/VAMP-Medium.svg" alt="">
      <p class="text">Code licensed under <a type="application/rss+xml" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2</a> © 2016 <a href="./about/">Magnetic.io</a></p>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59948816-1', 'auto');
  ga('send', 'pageview');

</script>

